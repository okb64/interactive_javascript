<!DOCTYPE html>
<html>
<body>
<canvas id="myCanvas" width="800" height="600" style="border:1px solid #000000; cursor: none;">
Your browser does not support the HTML canvas tag.</canvas>
<script>
var c = document.getElementById("myCanvas")
var ctx = c.getContext("2d")

var cursor_x = 0
var cursor_y = 0

ctx.strokeStyle = "#000000"
ctx.font = "15px monospace"

lobby = {
  test: 0,
  x: 10, xp:0,
  y: 10, yp:0,
  win1: null,
  win2: null,
  text_buffer:"",
  grabbing_window: false,
  resizing_window: false,
  keyp: function(k){
    if(k == "Enter"){
      try{
        eval(this.text_buffer);
      }catch(e){
        this.text_buffer = e.message;
      }
    }else if(k == "Backspace"){
      this.text_buffer = this.text_buffer.slice(0, -1)
    }else if(k == "Shift"){
    }else if(k == "Control"){
    }else if(k == "Alt"){
    }else if(k == "AltGraph"){
    }else if(k == "1"){
      if(this.resizing_window)
      this.resizing_window = false;
      else if(this.win2.cursor_inside()) this.resizing_window = true;
    }else{
      this.text_buffer = this.text_buffer + k
    }
  },
  mouse_click: function(){
    if(this.grabbing_window){
      this.grabbing_window = false;
    }else if(this.win2.cursor_inside()){
      this.grabbing_window = true;
    }
  },
  disp: {
    rect: function(a,b,c,d){
      ctx.lineWidth = 1
      ctx.strokeStyle = "#000000"
      ctx.fillStyle = "#000000"
      ctx.strokeRect(a,b,c,d)
    },
    clear: function(){
      ctx.clearRect(0, 0, c.width, c.height);
    },
  },
  tick_loop: function(){
    this.disp.clear()
    this.win1.display()
    this.win2.display()
    this.win1.x = this.xp;
    this.win1.y = this.yp
    this.win2.text = this.text_buffer
    this.draw_cursor()
    if(this.grabbing_window){
      this.win2.x = cursor_x;
      this.win2.y = cursor_y;
    }
    if(this.resizing_window){
      this.win2.size_x = cursor_x - this.win2.x;
      this.win2.size_y = cursor_y - this.win2.y;
    }
    this.xp+=0.5
    this.yp+=0.5
  },
  draw_cursor: function(){
    ctx.fillStyle = "#000000"
    ctx.strokeStyle = "#000000"
    ctx.lineWidth = 2
    ctx.beginPath()
    ctx.moveTo(cursor_x, cursor_y)
    ctx.lineTo(cursor_x + 12, cursor_y + 12)
    ctx.moveTo(cursor_x, cursor_y)
    ctx.lineTo(cursor_x, cursor_y + 10)
    ctx.moveTo(cursor_x, cursor_y)
    ctx.lineTo(cursor_x + 10, cursor_y)
    ctx.stroke()
    //ctx.fillRect(cursor_x, cursor_y, 10, 10)
  },
  dispframe_shared: {
    display: function(){
      ctx.fillStyle = "#ffffff"
      ctx.fillRect(this.x, this.y, this.size_x, this.size_y)
      ctx.fillStyle = "#000000"
      ctx.strokeStyle = "#000000"
      lobby.disp.rect(this.x, this.y, this.size_x, this.size_y)
      var y_pos = 0
      var x_pos = 0
      for(let i=0; i<this.text.length; i++){
        if(y_pos + 15 < this.size_y)
          ctx.fillText(this.text.charAt(i),
                        x_pos + this.x + 2,
                        y_pos + this.y + 14);
        if(x_pos + 2 > this.size_x - 16 ||
           this.text.charAt(i) == "\n"){
          x_pos = 0
          y_pos += 15
        }else{
          x_pos += 8
        }
      }
      if(y_pos + 15 < this.size_y)
        ctx.fillRect(x_pos + this.x + 4,
                     y_pos + this.y + 2, 8, 14);
    },
    cursor_inside: function(){
      return (cursor_x > this.x) &&
        (cursor_y > this.y) &&
        (cursor_x < this.size_x + this.x) &&
        (cursor_y < this.size_y + this.y);
    },
    print: function(text){
      this.text += text;
    }
  },
  dispframe: function(x, y, size_x, size_y){
    this.x = x;
    this.y = y;
    this.size_x = size_x;
    this.size_y = size_y;
    this.text = "";
    this.display = lobby.dispframe_shared.display;
    this.cursor_inside = lobby.dispframe_shared.cursor_inside;
    this.print = lobby.dispframe_shared.print;
  },
  init: function(){
    this.win1 = new this.dispframe(10, 10, 100, 100)
    this.win1.text = "functions are real, but the light cones are unescapable"
    this.win2 = new this.dispframe(20, 20, 400, 400)
    
  }
}


function set_pos(event){
  cursor_x = event.clientX - c.offsetLeft
  cursor_y = event.clientY - c.offsetTop
}

function key_pressed(event){
  console.log(event.key)
  lobby.keyp(event.key)
}

function mouse_pressed(){
  lobby.mouse_click();
}
lobby.init();
  
window.addEventListener('load', ()=>{

  document.addEventListener('mousemove', set_pos);
  document.addEventListener('keydown', key_pressed);
  document.addEventListener('mousedown', mouse_pressed);
  window.setInterval(function(){
    lobby.tick_loop();
  }, 10)
});

</script>
</body>
</html>